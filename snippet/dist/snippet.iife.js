!function(){"use strict";class t{constructor(t){this.customerId=null,this.cartToken=null,this.fingerprintHash=null,this.mouseBuffer=[],this.mouseFlushInterval=null,this.heartbeatInterval=null,this.scrollY=0,this.viewportWidth=0,this.viewportHeight=0,this.config=t,this.sessionId=this.getOrCreateSessionId(),this.init()}async init(){console.log("游분 Eagle B2B Engine initialized"),this.loadToken(),this.detectCustomer(),this.collectFingerprint(),this.trackPageView(),this.setupEventListeners(),this.setupCartTracking(),this.setupCustomerSync(),this.setupCheckoutAutofill(),this.startHeartbeat(),this.startMouseTracking()}startHeartbeat(){this.sendHeartbeat(),this.heartbeatInterval=setInterval(()=>this.sendHeartbeat(),3e4),window.addEventListener("beforeunload",()=>{this.heartbeatInterval&&clearInterval(this.heartbeatInterval);const t=JSON.stringify({shop:this.config.shop,sessionId:this.sessionId,fingerprintHash:this.fingerprintHash,status:"offline",timestamp:Date.now()});navigator.sendBeacon(`${this.config.apiUrl}/api/v1/fingerprint/heartbeat`,new Blob([t],{type:"application/json"}))}),document.addEventListener("visibilitychange",()=>{document.hidden?this.sendHeartbeat("away"):this.sendHeartbeat("online")})}async sendHeartbeat(t="online"){try{await fetch(`${this.config.apiUrl}/api/v1/fingerprint/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:this.config.shop,sessionId:this.sessionId,fingerprintHash:this.fingerprintHash,eagleToken:this.config.token||localStorage.getItem("eagle_token"),status:t,timestamp:Date.now(),page:{url:window.location.href,path:window.location.pathname,title:document.title,referrer:document.referrer},viewport:{width:window.innerWidth,height:window.innerHeight,scrollY:window.scrollY}}),keepalive:!0})}catch{}}startMouseTracking(){this.viewportWidth=window.innerWidth,this.viewportHeight=window.innerHeight;let t=0;document.addEventListener("mousemove",e=>{const i=Date.now();i-t<100||(t=i,this.mouseBuffer.push({x:Math.round(e.clientX/this.viewportWidth*1e4)/100,y:Math.round(e.clientY/this.viewportHeight*1e4)/100,t:i,type:"m"}))}),document.addEventListener("click",t=>{var e,i,n,o;const a=t.target;this.mouseBuffer.push({x:Math.round(t.clientX/this.viewportWidth*1e4)/100,y:Math.round(t.clientY/this.viewportHeight*1e4)/100,t:Date.now(),type:"c"}),this.trackEvent("click",{url:window.location.href,path:window.location.pathname,elementTag:a.tagName,elementText:null==(i=null==(e=a.textContent)?void 0:e.slice(0,50))?void 0:i.trim(),elementId:a.id||void 0,elementClass:(null==(o=null==(n=a.className)?void 0:n.toString())?void 0:o.slice(0,100))||void 0,x:Math.round(t.clientX/this.viewportWidth*100),y:Math.round(t.clientY/this.viewportHeight*100)})});let e=0;window.addEventListener("scroll",()=>{const t=Date.now();t-e<200||(e=t,this.scrollY=window.scrollY,this.mouseBuffer.push({x:0,y:Math.round(window.scrollY/(document.body.scrollHeight-window.innerHeight)*1e4)/100,t:t,type:"s"}))}),window.addEventListener("resize",()=>{this.viewportWidth=window.innerWidth,this.viewportHeight=window.innerHeight}),this.mouseFlushInterval=setInterval(()=>this.flushMouseBuffer(),5e3),window.addEventListener("beforeunload",()=>{this.mouseFlushInterval&&clearInterval(this.mouseFlushInterval),this.flushMouseBuffer(!0)})}flushMouseBuffer(t=!1){if(0===this.mouseBuffer.length)return;const e={shop:this.config.shop,sessionId:this.sessionId,fingerprintHash:this.fingerprintHash,viewport:{width:this.viewportWidth,height:this.viewportHeight},pageUrl:window.location.href,events:this.mouseBuffer.splice(0)};t?navigator.sendBeacon(`${this.config.apiUrl}/api/v1/fingerprint/mouse`,new Blob([JSON.stringify(e)],{type:"application/json"})):fetch(`${this.config.apiUrl}/api/v1/fingerprint/mouse`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0}).catch(()=>{})}async collectFingerprint(){try{const t=await this.generateFingerprint();this.fingerprintHash=t.hash;const e=this.detectEmail(),i=this.detectShopifyCustomerId(),n={shop:this.config.shop,fingerprintHash:t.hash,sessionId:this.sessionId,eagleToken:this.config.token||void 0,email:e||void 0,shopifyCustomerId:i||void 0,...t.signals,signalCount:t.signalCount},o=await fetch(`${this.config.apiUrl}/api/v1/fingerprint/collect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok){const t=await o.json();t.isReturning&&console.log(`游분 Eagle: Returning visitor (visit #${t.visitCount})`)}}catch(t){console.error("游분 Eagle: Fingerprint collection failed",t)}}async generateFingerprint(){var t,e;const i={};let n=0;try{const t=document.createElement("canvas");t.width=256,t.height=128;const e=t.getContext("2d");if(e){e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.font="11pt Arial",e.fillText("Eagle B2B 游분",2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.font="18pt Arial",e.fillText("Canvas FP",4,45);const o=e.createLinearGradient(0,0,t.width,0);o.addColorStop(0,"#ff0000"),o.addColorStop(.5,"#00ff00"),o.addColorStop(1,"#0000ff"),e.fillStyle=o,e.fillRect(0,60,t.width,20),e.beginPath(),e.arc(50,100,25,0,2*Math.PI,!0),e.closePath(),e.fill(),i.canvasHash=await this.hashString(t.toDataURL()),n++}}catch{}try{const t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(e){const t=e,o=t.getExtension("WEBGL_debug_renderer_info");o&&(i.gpuVendor=t.getParameter(o.UNMASKED_VENDOR_WEBGL),i.gpuRenderer=t.getParameter(o.UNMASKED_RENDERER_WEBGL),n+=2);const a=[t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),t.getParameter(t.MAX_RENDERBUFFER_SIZE),t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_TEXTURE_SIZE),t.getParameter(t.MAX_VARYING_VECTORS),t.getParameter(t.MAX_VERTEX_ATTRIBS),t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),t.getParameter(t.MAX_VIEWPORT_DIMS),t.getParameter(t.RENDERER),t.getParameter(t.VENDOR)].join("|");i.webglHash=await this.hashString(a),n++}}catch{}try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),o=t.createAnalyser(),a=t.createGain(),r=t.createScriptProcessor(4096,1,1);a.gain.value=0,e.type="triangle",e.frequency.setValueAtTime(1e4,t.currentTime),e.connect(o),o.connect(r),r.connect(a),a.connect(t.destination),e.start(0);const s=await new Promise(i=>{r.onaudioprocess=n=>{const o=n.inputBuffer.getChannelData(0);let s=0;for(let t=0;t<o.length;t++)s+=Math.abs(o[t]);e.disconnect(),r.disconnect(),a.disconnect(),t.close(),i(s.toString())}});i.audioHash=await this.hashString(s),n++}catch{}i.userAgent=navigator.userAgent,i.platform=navigator.platform,i.language=navigator.language,i.languages=null==(t=navigator.languages)?void 0:t.join(","),i.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,i.timezoneOffset=(new Date).getTimezoneOffset(),n+=6,i.screenWidth=screen.width,i.screenHeight=screen.height,i.colorDepth=screen.colorDepth,i.pixelRatio=window.devicePixelRatio,i.touchSupport="ontouchstart"in window||navigator.maxTouchPoints>0,n+=5,i.hardwareConcurrency=navigator.hardwareConcurrency||0,i.deviceMemory=navigator.deviceMemory||null,i.maxTouchPoints=navigator.maxTouchPoints||0,n+=3,i.cookiesEnabled=navigator.cookieEnabled,i.doNotTrack=navigator.doNotTrack||window.doNotTrack||null,i.pluginCount=(null==(e=navigator.plugins)?void 0:e.length)||0,n+=3;const o=navigator.connection;o&&(i.connectionType=o.effectiveType||o.type,n++);try{const t="mmmmmmmmmmMLI",e=["monospace","sans-serif","serif"],o=["Arial","Courier New","Georgia","Helvetica","Times New Roman","Trebuchet MS","Verdana","Comic Sans MS","Impact","Lucida Console","Tahoma","Palatino Linotype","Segoe UI","Roboto"],a=document.createElement("canvas").getContext("2d");if(a){const r=e=>(a.font=`72px ${e}`,a.measureText(t).width),s=e.map(t=>r(t));let c=0;for(const t of o)for(let i=0;i<e.length;i++)if(r(`'${t}', ${e[i]}`)!==s[i]){c++;break}i.fontCount=c,n++}}catch{}try{const t=document.createElement("div");t.innerHTML="&nbsp;",t.className="adsbox ad-banner",t.style.cssText="position:absolute;top:-999px;left:-999px;width:1px;height:1px;",document.body.appendChild(t),await new Promise(t=>setTimeout(t,100)),i.adBlockDetected=0===t.offsetHeight||null===t.offsetParent,document.body.removeChild(t),n++}catch{}const a=[i.canvasHash,i.webglHash,i.audioHash,i.platform,i.timezone,i.screenWidth,i.screenHeight,i.hardwareConcurrency,i.gpuRenderer,i.language,i.colorDepth].filter(Boolean).join("|");return{hash:await this.hashString(a),signals:i,signalCount:n}}async hashString(t){try{const e=(new TextEncoder).encode(t),i=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(i)).map(t=>t.toString(16).padStart(2,"0")).join("")}catch{let e=0;for(let i=0;i<t.length;i++){e=(e<<5)-e+t.charCodeAt(i),e|=0}return Math.abs(e).toString(16).padStart(8,"0")}}detectEmail(){var t,e;if(null==(e=null==(t=window.Shopify)?void 0:t.customer)?void 0:e.email)return window.Shopify.customer.email;const i=document.querySelector('meta[name="customer-email"]');if(i)return i.getAttribute("content");const n=localStorage.getItem("eagle_checkout_autofill");if(n)try{return JSON.parse(n).email}catch{}return null}detectShopifyCustomerId(){var t,e,i,n,o;return(null==(i=null==(e=null==(t=window.ShopifyAnalytics)?void 0:t.meta)?void 0:e.page)?void 0:i.customerId)?window.ShopifyAnalytics.meta.page.customerId.toString():(null==(o=null==(n=window.Shopify)?void 0:n.customer)?void 0:o.id)?window.Shopify.customer.id.toString():null}detectCustomer(){const t=this.detectShopifyCustomerId();t&&(this.customerId=t,this.syncCustomerToEagle())}getOrCreateSessionId(){const t="eagle_session_id";let e=sessionStorage.getItem(t);return e||(e=`eagle-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,sessionStorage.setItem(t,e)),e}async syncCustomerToEagle(){if(this.customerId)try{await fetch(`${this.config.apiUrl}/api/v1/events/collect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:this.config.shop,sessionId:this.sessionId,eagleToken:this.config.token,shopifyCustomerId:this.customerId,eventType:"customer_session",payload:{timestamp:(new Date).toISOString(),fingerprintHash:this.fingerprintHash}})})}catch(t){console.error("Eagle: Customer sync failed",t)}}setupCartTracking(){if("undefined"!=typeof window){console.log("游분 Eagle: Setting up cart tracking");const t=window.fetch;window.fetch=async(...e)=>{var i;const n=await t(...e),o=(null==(i=e[0])?void 0:i.toString())||"";return(o.includes("/cart/")||o.includes("/cart.js")||o.includes("/cart/add.js"))&&setTimeout(()=>this.syncCartToEagle(),500),n},setTimeout(()=>this.syncCartToEagle(),1e3),setInterval(()=>this.syncCartToEagle(),3e4),document.addEventListener("cart:updated",()=>this.syncCartToEagle())}}async syncCartToEagle(){var t,e;try{const i=await fetch("/cart.js");if(!i.ok)return;const n=await i.json();if(!n.items||0===n.items.length||!n.token)return;this.cartToken=n.token;let o=null;(null==(e=null==(t=window.Shopify)?void 0:t.customer)?void 0:e.email)&&(o=window.Shopify.customer.email);const a={cartToken:this.cartToken,shopDomain:this.config.shop,customerEmail:o,fingerprintHash:this.fingerprintHash,items:n.items.map(t=>({shopifyVariantId:t.variant_id,title:t.title,variantTitle:t.variant_title||void 0,quantity:t.quantity,price:t.price/100,imageUrl:t.image||void 0})),subtotal:n.total_price/100,total:n.total_price/100,currency:n.currency,checkoutUrl:"/checkout"};await fetch(`${this.config.apiUrl}/api/v1/abandoned-carts/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(i){console.error("Eagle: Cart sync failed",i)}}setupCustomerSync(){const t=()=>{var t,e;(null==(t=window.Shopify)?void 0:t.customer)&&(this.customerId=null==(e=window.Shopify.customer.id)?void 0:e.toString(),this.config.token&&this.linkCustomerAccounts())};t(),setInterval(t,5e3)}async linkCustomerAccounts(){if(this.customerId&&this.config.token)try{await fetch(`${this.config.apiUrl}/api/v1/events/collect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:this.config.shop,sessionId:this.sessionId,eagleToken:this.config.token,shopifyCustomerId:this.customerId,eventType:"customer_link",payload:{timestamp:(new Date).toISOString(),action:"link_accounts",fingerprintHash:this.fingerprintHash}})})}catch(t){console.error("Eagle: Account linking failed",t)}}loadToken(){const t=localStorage.getItem("eagle_token");t&&(this.config.token=t)}async trackEvent(t,e){const i={shop:this.config.shop,sessionId:this.sessionId,eagleToken:this.config.token,eventType:t,fingerprintHash:this.fingerprintHash,payload:{...e,fingerprintHash:this.fingerprintHash},timestamp:(new Date).toISOString()};try{fetch(`${this.config.apiUrl}/api/v1/events/collect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(()=>{}),fetch(`${this.config.apiUrl}/api/v1/fingerprint/event`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(()=>{})}catch(n){console.error("Eagle: Failed to track event",n)}}trackPageView(){this.trackEvent("page_view",{url:window.location.href,path:window.location.pathname,referrer:document.referrer})}setupEventListeners(){window.location.pathname.includes("/products/")&&this.trackProductView(),document.addEventListener("click",t=>{const e=t.target;(e.closest('[name="add"]')||e.closest(".product-form__submit"))&&this.trackAddToCart()})}trackProductView(){var t,e,i,n,o,a;const r=document.querySelector('meta[property="og:product_id"]'),s=(null==(t=document.querySelector('meta[property="og:title"]'))?void 0:t.getAttribute("content"))||(null==(i=null==(e=document.querySelector("h1"))?void 0:e.textContent)?void 0:i.trim()),c=(null==(n=document.querySelector('meta[property="og:price:amount"]'))?void 0:n.getAttribute("content"))||(null==(a=null==(o=document.querySelector(".price__regular .price-item--regular"))?void 0:o.textContent)?void 0:a.replace(/[^0-9.]/g,""));if(r){const t=r.getAttribute("content"),e=new URLSearchParams(window.location.search).get("variant");this.trackEvent("product_view",{productId:t,variantId:e,productTitle:s,productPrice:c?parseFloat(c):void 0,url:window.location.href,path:window.location.pathname,referrer:document.referrer})}}trackAddToCart(){var t,e,i,n,o;const a=null==(e=null==(t=window.ShopifyAnalytics)?void 0:t.meta)?void 0:e.product,r=document.querySelector('input[name="quantity"]'),s=r?parseInt(r.value,10):1;this.trackEvent("add_to_cart",{url:window.location.href,path:window.location.pathname,productId:null==(i=null==a?void 0:a.id)?void 0:i.toString(),productTitle:(null==a?void 0:a.type)||(null==(o=null==(n=document.querySelector("h1"))?void 0:n.textContent)?void 0:o.trim()),quantity:s})}setToken(t){this.config.token=t,localStorage.setItem("eagle_token",t),this.collectFingerprint()}clearToken(){this.config.token=void 0,localStorage.removeItem("eagle_token")}setupCheckoutAutofill(){if(!window.location.href.includes("/checkout")&&!window.location.href.includes("/checkouts"))return;const t=()=>{try{const t=localStorage.getItem("eagle_checkout_autofill")||sessionStorage.getItem("eagle_checkout_autofill");if(!t)return!1;const e=JSON.parse(t);if(Date.now()-e.timestamp>3e5)return localStorage.removeItem("eagle_checkout_autofill"),sessionStorage.removeItem("eagle_checkout_autofill"),!1;let i=0;const n=(t,e)=>{const n=document.querySelector(t);n&&e&&!n.value&&(n.value=e,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),i++)},o=(t,e)=>{const n=document.querySelector(t);if(n&&e){const t=Array.from(n.options).find(t=>{var i;return t.value===e||(null==(i=t.textContent)?void 0:i.includes(e))});t&&n.value!==t.value&&(n.value=t.value,n.dispatchEvent(new Event("change",{bubbles:!0})),i++)}};return n("#email",e.email),n('input[name="email"]',e.email),n('input[autocomplete="email"]',e.email),n('input[autocomplete="shipping given-name"]',e.firstName),n('input[autocomplete="given-name"]',e.firstName),n('input[autocomplete="shipping family-name"]',e.lastName),n('input[autocomplete="family-name"]',e.lastName),n('input[autocomplete="shipping address-line1"]',e.address1),n('input[autocomplete="address-line1"]',e.address1),e.address2&&n('input[autocomplete="address-line2"]',e.address2),n('input[autocomplete="shipping address-level2"]',e.city),n('input[autocomplete="address-level2"]',e.city),o('select[autocomplete="shipping address-level1"]',e.state),o('select[autocomplete="address-level1"]',e.state),n('input[autocomplete="shipping postal-code"]',e.zip),n('input[autocomplete="postal-code"]',e.zip),e.country&&o('select[autocomplete="country"]',e.country),i>0&&setTimeout(()=>{localStorage.removeItem("eagle_checkout_autofill"),sessionStorage.removeItem("eagle_checkout_autofill")},1e4),i>0}catch{return!1}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(t,500),setTimeout(t,2e3),setTimeout(t,5e3)}):(t(),setTimeout(t,500),setTimeout(t,2e3));const e=new MutationObserver(()=>t());e.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>e.disconnect(),3e4)}}!function(){var e,i,n;const o=document.currentScript,a=(null==o?void 0:o.getAttribute("data-api-url"))||"https://api.eagledtfsupply.com";let r=(null==o?void 0:o.getAttribute("data-shop"))||"";if(!r&&"undefined"!=typeof window)if(null==(e=window.Shopify)?void 0:e.shop)r=window.Shopify.shop;else if(window.location.hostname.includes(".myshopify.com"))r=window.location.hostname;else if(null==(n=null==(i=window.Shopify)?void 0:i.Checkout)?void 0:n.apiHost)r=window.Shopify.Checkout.apiHost;else{const t=document.querySelector('meta[name="shopify-shop"]');t&&(r=t.getAttribute("content")||"")}r||console.warn("游분 Eagle: Could not detect shop domain"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.Eagle=new t({apiUrl:a,shop:r})}):window.Eagle=new t({apiUrl:a,shop:r})}()}();
